<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mouse and Keyboard Input with WebSocket</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #f8f9fa;
      }
      #mouseArea {
        width: 500px;
        height: 300px;
        border: 2px solid black;
        margin: 20px auto;
        position: relative;
        touch-action: none; /* Prevent default touch behavior */
      }
      #output {
        white-space: pre-wrap;
        margin: 20px 0;
        padding: 20px;
        border: 1px solid #ddd;
        background-color: #fff;
        max-width: 800px;
        width: 100%;
        overflow: auto;
      }
      .error {
        color: red;
      }
    </style>
  </head>
  <body>
    <div class="container mt-5">
      <h1 class="text-center mb-4">Mouse and Keyboard Input</h1>
      <p>
        Move your finger inside the box or type in the input field. Commands are
        sent via WebSocket.
      </p>

      <div id="mouseArea">Move your finger here</div>
      <br />
      <input
        type="text"
        id="keyboardInput"
        placeholder="Type something here..."
        class="form-control"
      />

      <h3 class="mt-5">WebSocket Communication</h3>
      <div id="output" class="mt-4"></div>

      <script>
        const socket = new WebSocket("ws://192.168.1.8:5000/ws");
        const outputDiv = document.getElementById("output");

        // WebSocket event listeners
        socket.addEventListener("open", function () {
          console.log("Connected to WebSocket server");
          outputDiv.innerHTML = `<p>Connected to WebSocket server</p>`;
        });

        socket.addEventListener("message", function (event) {
          let data;
          try {
            data = JSON.parse(event.data);
            outputDiv.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
          } catch (e) {
            outputDiv.innerHTML = `<p class="error">Error parsing message: ${e.message}</p><pre>${event.data}</pre>`;
          }
        });

        socket.addEventListener("error", function (event) {
          outputDiv.innerHTML = `<p class="error">Error: ${event.message || "WebSocket error"}</p>`;
        });

        socket.addEventListener("close", function () {
          outputDiv.innerHTML = `<p>Connection closed</p>`;
        });

        // Mouse movement event listener (for desktop)
        document
          .getElementById("mouseArea")
          .addEventListener("mousemove", function (event) {
            const message = JSON.stringify({
              command: "move_cursor",
              args: [event.offsetX, event.offsetY], // Use offsetX and offsetY for relative coordinates
            });
            socket.send(message);
          });

        // Touch movement event listener (for smartphones)
        document
          .getElementById("mouseArea")
          .addEventListener("touchmove", function (event) {
            event.preventDefault(); // Prevent default touch behavior (e.g., scrolling)
            const touch = event.touches[0]; // Get the first touch point
            const rect = event.target.getBoundingClientRect();
            const x = touch.clientX - rect.left; // Calculate relative X position
            const y = touch.clientY - rect.top; // Calculate relative Y position

            const message = JSON.stringify({
              command: "move_cursor",
              args: [x, y],
            });
            socket.send(message);
          });

        // Keyboard input event listener
        document
          .getElementById("keyboardInput")
          .addEventListener("keydown", function (event) {
            const message = JSON.stringify({
              command: "keyboard_input",
              args: [event.key],
            });
            socket.send(message);
          });
      </script>
    </div>
  </body>
</html>
